name: CI Pipeline - Base Images

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*.*.*'  # Semantic versioning tags: v1.0.0, v1.2.3, etc.
  pull_request:
    branches: [ main, develop ]

# Prevent workflow from running on commits with [skip ci] or [ci skip]
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

env:
  REGISTRY: docker.io
  REGISTRY_URL: dhi.io
  DOCKER_HUB_USERNAME: raphaelmoraes
  BASE_IMAGE: raphaelmoraes/digital-step-flow-base-node
  CICD_RUNNER_IMAGE: raphaelmoraes/digital-step-flow-cicd-runner
  NODEJS_VERSION: 24.13.0-r1
  NPM_VERSION: 11.6.3-r0
  ALPINE_BASE_VERSION: 3.23-alpine3.23-dev

jobs:
  build-workload-node24:
    name: Build Workload Node 24 Image
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to create tags
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for tags
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            workload-node24:
              - 'workload/node-24/**'
      
      - name: Configure Git
        if: steps.filter.outputs.workload-node24 == 'true' || (github.event_name == 'push' && github.ref_type == 'tag')
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Determine version based on branch strategy
        id: version
        env:
          GITHUB_REF_TYPE: ${{ github.ref_type }}
          GITHUB_REF: ${{ github.ref }}
          GITHUB_HEAD_REF: ${{ github.event.head_ref }}
          GITHUB_EVENT_PULL_REQUEST_HEAD_REF: ${{ github.event.pull_request.head.ref }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          source scripts/version.sh
          determine_version \
            "$GITHUB_REF_TYPE" \
            "$GITHUB_REF" \
            "$GITHUB_HEAD_REF" \
            "$GITHUB_EVENT_PULL_REQUEST_HEAD_REF" \
            "$GITHUB_REF_NAME"
          echo "Determined version: ${{ steps.version.outputs.version }}"
      
      - name: Set up Docker Buildx
        if: steps.filter.outputs.workload-node24 == 'true' || (github.event_name == 'push' && github.ref_type == 'tag')
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to dhi.io registry
        if: steps.filter.outputs.workload-node24 == 'true' || (github.event_name == 'push' && github.ref_type == 'tag')
        run: |
          echo "${{ secrets.DOCKERHUB_PAT }}" | docker login dhi.io -u "${{ secrets.DOCKERHUB_USER }}" --password-stdin
      
      - name: Log in to Docker Hub
        if: steps.filter.outputs.workload-node24 == 'true' || (github.event_name == 'push' && github.ref_type == 'tag')
        run: |
          echo "${{ secrets.DOCKERHUB_PAT }}" | docker login -u "${{ secrets.DOCKERHUB_USER }}" --password-stdin
      
      - name: Validate version
        if: steps.filter.outputs.workload-node24 == 'true' || (github.event_name == 'push' && github.ref_type == 'tag')
        run: |
          if [[ -z "${{ steps.version.outputs.version }}" ]]; then
            echo "ERROR: Version is empty!" >&2
            exit 1
          fi
          echo "Building with version: ${{ steps.version.outputs.version }}"
      
      - name: Build and push workload node24 image
        if: steps.filter.outputs.workload-node24 == 'true' || (github.event_name == 'push' && github.ref_type == 'tag')
        uses: docker/bake-action@v5
        with:
          files: workload/node-24/docker-bake.hcl
          targets: base_image,base_image_dev
          push: true
          set: |
            *.args.REGISTRY_URL=${{ env.REGISTRY_URL }}
            *.args.ALPINE_BASE_VERSION=${{ env.ALPINE_BASE_VERSION }}
            *.args.NODEJS_VERSION=${{ env.NODEJS_VERSION }}
            *.args.NPM_VERSION=${{ env.NPM_VERSION }}
            *.args.BASE_IMAGE_VERSION=${{ steps.version.outputs.version }}
      
      - name: Pull image for scanning
        if: steps.filter.outputs.workload-node24 == 'true' || (github.event_name == 'push' && github.ref_type == 'tag')
        run: |
          echo "${{ secrets.DOCKERHUB_PAT }}" | docker login -u "${{ secrets.DOCKERHUB_USER }}" --password-stdin
          docker pull ${{ env.BASE_IMAGE }}:${{ steps.version.outputs.version }}
      
      - name: Run Trivy vulnerability scanner
        if: steps.filter.outputs.workload-node24 == 'true' || (github.event_name == 'push' && github.ref_type == 'tag')
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: '${{ env.BASE_IMAGE }}:${{ steps.version.outputs.version }}'
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'
          scanners: 'vuln'
          skip-dirs: './.venv'
      
      - name: Save Trivy table output to file
        if: steps.filter.outputs.workload-node24 == 'true' || (github.event_name == 'push' && github.ref_type == 'tag')
        run: |
          trivy image \
            --skip-version-check \
            --scanners vuln \
            --skip-dirs "./.venv" \
            --ignore-unfixed \
            --format table \
            --severity CRITICAL,HIGH \
            --output trivy-image-base.txt \
            '${{ env.BASE_IMAGE }}:${{ steps.version.outputs.version }}' || true
      
      - name: Generate Trivy reports (HTML, XML, SBOM, JSON)
        if: steps.filter.outputs.workload-node24 == 'true' || (github.event_name == 'push' && github.ref_type == 'tag')
        env:
          IMAGE_REF: ${{ env.BASE_IMAGE }}:${{ steps.version.outputs.version }}
        run: |
          # Validate IMAGE_REF is set
          if [[ -z "${IMAGE_REF}" ]]; then
            echo "ERROR: IMAGE_REF is empty!" >&2
            echo "BASE_IMAGE: ${{ env.BASE_IMAGE }}" >&2
            echo "VERSION: ${{ steps.version.outputs.version }}" >&2
            exit 1
          fi
          echo "INFO: Scanning image: ${IMAGE_REF}"
          
          # Download templates
          mkdir -p /tmp/trivy-templates
          curl -sSL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/html.tpl -o /tmp/trivy-templates/trivy-html.tpl
          curl -sSL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/junit.tpl -o /tmp/trivy-templates/trivy-junit.tpl || echo "JUnit template not available, skipping XML report"
          
          # Output options (without exit code to ensure reports are generated)
          TRIVY_OUTPUT_OPTS="--skip-version-check --scanners vuln --skip-dirs ./.venv --ignore-unfixed"
          
          # Generate HTML report
          trivy image ${TRIVY_OUTPUT_OPTS} -o trivy-image-base.html --format template --template /tmp/trivy-templates/trivy-html.tpl "${IMAGE_REF}" >/dev/null 2>outerr_html.log || rc_html=$?
          if [[ ${rc_html:-0} -ne 0 && -f "./outerr_html.log" ]]; then
            echo "ERROR: Failed to generate HTML report:" >&2
            cat ./outerr_html.log >&2
          else
            echo "INFO: Scan completed. Result HTML output path $(pwd)/trivy-image-base.html"
          fi
          
          # Generate XML (JUnit) report
          if [[ -f /tmp/trivy-templates/trivy-junit.tpl ]]; then
            trivy image ${TRIVY_OUTPUT_OPTS} -o trivy-image-base.xml --format template --template /tmp/trivy-templates/trivy-junit.tpl "${IMAGE_REF}" >/dev/null 2>outerr_xml.log || rc_xml=$?
            if [[ ${rc_xml:-0} -ne 0 && -f "./outerr_xml.log" ]]; then
              echo "ERROR: Failed to generate XML report:" >&2
              cat ./outerr_xml.log >&2
            else
              echo "INFO: Scan completed. Result XML (Junit) output path $(pwd)/trivy-image-base.xml"
            fi
          fi
          
          # Generate SBOM report
          trivy image ${TRIVY_OUTPUT_OPTS} -o trivy-image-base-sbom.json --format cyclonedx "${IMAGE_REF}" >/dev/null 2>outerr_sbom.log || rc_sbom=$?
          if [[ ${rc_sbom:-0} -ne 0 && -f "./outerr_sbom.log" ]]; then
            echo "ERROR: Failed to generate SBOM report:" >&2
            cat ./outerr_sbom.log >&2
          else
            echo "INFO: Scan completed. Result SBOM output path $(pwd)/trivy-image-base-sbom.json"
          fi
          
          # Generate JSON report
          trivy image ${TRIVY_OUTPUT_OPTS} --format json --output trivy-image-base.json "${IMAGE_REF}" >/dev/null 2>outerr_json.log || rc_json=$?
          if [[ ${rc_json:-0} -ne 0 && -f "./outerr_json.log" ]]; then
            echo "ERROR: Failed to generate JSON report:" >&2
            cat ./outerr_json.log >&2
          fi
      
      - name: Upload Trivy reports
        if: (steps.filter.outputs.workload-node24 == 'true' || (github.event_name == 'push' && github.ref_type == 'tag')) && always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-reports-base-image-${{ steps.version.outputs.version }}
          path: |
            trivy-image-base.txt
            trivy-image-base.json
            trivy-image-base.html
            trivy-image-base.xml
            trivy-image-base-sbom.json
          retention-days: 30

  build-cicd-runner:
    name: Build CI/CD Runner Image
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to create tags
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for tags
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            cicd-runner:
              - 'cicd-runner/**'
      
      - name: Configure Git
        if: steps.filter.outputs.cicd-runner == 'true' || (github.event_name == 'push' && github.ref_type == 'tag')
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Determine version based on branch strategy
        id: version
        env:
          GITHUB_REF_TYPE: ${{ github.ref_type }}
          GITHUB_REF: ${{ github.ref }}
          GITHUB_HEAD_REF: ${{ github.event.head_ref }}
          GITHUB_EVENT_PULL_REQUEST_HEAD_REF: ${{ github.event.pull_request.head.ref }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          source scripts/version.sh
          determine_version \
            "$GITHUB_REF_TYPE" \
            "$GITHUB_REF" \
            "$GITHUB_HEAD_REF" \
            "$GITHUB_EVENT_PULL_REQUEST_HEAD_REF" \
            "$GITHUB_REF_NAME"
          echo "Determined version: ${{ steps.version.outputs.version }}"
      
      - name: Set up Docker Buildx
        if: steps.filter.outputs.cicd-runner == 'true' || (github.event_name == 'push' && github.ref_type == 'tag')
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to dhi.io registry
        if: steps.filter.outputs.cicd-runner == 'true' || (github.event_name == 'push' && github.ref_type == 'tag')
        run: |
          echo "${{ secrets.DOCKERHUB_PAT }}" | docker login dhi.io -u "${{ secrets.DOCKERHUB_USER }}" --password-stdin
      
      - name: Log in to Docker Hub
        if: steps.filter.outputs.cicd-runner == 'true' || (github.event_name == 'push' && github.ref_type == 'tag')
        run: |
          echo "${{ secrets.DOCKERHUB_PAT }}" | docker login -u "${{ secrets.DOCKERHUB_USER }}" --password-stdin
      
      - name: Build and push CI/CD runner image
        if: steps.filter.outputs.cicd-runner == 'true' || (github.event_name == 'push' && github.ref_type == 'tag')
        uses: docker/bake-action@v5
        with:
          files: cicd-runner/docker-bake.hcl
          targets: cicd_runner
          push: true
          set: |
            *.args.REGISTRY_URL=${{ env.REGISTRY_URL }}
            *.args.ALPINE_BASE_VERSION=${{ env.ALPINE_BASE_VERSION }}
            *.args.CICD_RUNNER_VERSION=${{ steps.version.outputs.version }}
            cicd_runner.tags=${{ env.CICD_RUNNER_IMAGE }}:${{ steps.version.outputs.version }}
      
      - name: Pull image for scanning
        if: steps.filter.outputs.cicd-runner == 'true' || (github.event_name == 'push' && github.ref_type == 'tag')
        run: |
          echo "${{ secrets.DOCKERHUB_PAT }}" | docker login -u "${{ secrets.DOCKERHUB_USER }}" --password-stdin
          docker pull ${{ env.CICD_RUNNER_IMAGE }}:${{ steps.version.outputs.version }}
      
      - name: Run Trivy vulnerability scanner
        if: steps.filter.outputs.cicd-runner == 'true' || (github.event_name == 'push' && github.ref_type == 'tag')
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: '${{ env.CICD_RUNNER_IMAGE }}:${{ steps.version.outputs.version }}'
          format: 'table'
          exit-code: '0'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH,MEDIUM'
          scanners: 'vuln'
      
      - name: Save Trivy table output to file
        if: steps.filter.outputs.cicd-runner == 'true' || (github.event_name == 'push' && github.ref_type == 'tag')
        run: |
          trivy image \
            --skip-version-check \
            --scanners vuln \
            --skip-dirs "./.venv" \
            --ignore-unfixed \
            --format table \
            --severity CRITICAL,HIGH,MEDIUM \
            --output trivy-image-cicd-runner.txt \
            '${{ env.CICD_RUNNER_IMAGE }}:${{ steps.version.outputs.version }}' || true
      
      - name: Generate Trivy reports (HTML, XML, SBOM, JSON)
        if: steps.filter.outputs.cicd-runner == 'true' || (github.event_name == 'push' && github.ref_type == 'tag')
        env:
          IMAGE_REF: ${{ env.CICD_RUNNER_IMAGE }}:${{ steps.version.outputs.version }}
        run: |
          # Validate IMAGE_REF is set
          if [[ -z "${IMAGE_REF}" ]]; then
            echo "ERROR: IMAGE_REF is empty!" >&2
            echo "CICD_RUNNER_IMAGE: ${{ env.CICD_RUNNER_IMAGE }}" >&2
            echo "VERSION: ${{ steps.version.outputs.version }}" >&2
            exit 1
          fi
          echo "INFO: Scanning image: ${IMAGE_REF}"
          
          # Download templates
          mkdir -p /tmp/trivy-templates
          curl -sSL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/html.tpl -o /tmp/trivy-templates/trivy-html.tpl
          curl -sSL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/junit.tpl -o /tmp/trivy-templates/trivy-junit.tpl || echo "JUnit template not available, skipping XML report"
          
          # Output options (without exit code to ensure reports are generated)
          TRIVY_OUTPUT_OPTS="--skip-version-check --scanners vuln --skip-dirs ./.venv --ignore-unfixed"
          
          # Generate HTML report
          trivy image ${TRIVY_OUTPUT_OPTS} -o trivy-image-cicd-runner.html --format template --template /tmp/trivy-templates/trivy-html.tpl "${IMAGE_REF}" >/dev/null 2>outerr_html.log || rc_html=$?
          if [[ ${rc_html:-0} -ne 0 && -f "./outerr_html.log" ]]; then
            echo "ERROR: Failed to generate HTML report:" >&2
            cat ./outerr_html.log >&2
          else
            echo "INFO: Scan completed. Result HTML output path $(pwd)/trivy-image-cicd-runner.html"
          fi
          
          # Generate XML (JUnit) report
          if [[ -f /tmp/trivy-templates/trivy-junit.tpl ]]; then
            trivy image ${TRIVY_OUTPUT_OPTS} -o trivy-image-cicd-runner.xml --format template --template /tmp/trivy-templates/trivy-junit.tpl "${IMAGE_REF}" >/dev/null 2>outerr_xml.log || rc_xml=$?
            if [[ ${rc_xml:-0} -ne 0 && -f "./outerr_xml.log" ]]; then
              echo "ERROR: Failed to generate XML report:" >&2
              cat ./outerr_xml.log >&2
            else
              echo "INFO: Scan completed. Result XML (Junit) output path $(pwd)/trivy-image-cicd-runner.xml"
            fi
          fi
          
          # Generate SBOM report
          trivy image ${TRIVY_OUTPUT_OPTS} -o trivy-image-cicd-runner-sbom.json --format cyclonedx "${IMAGE_REF}" >/dev/null 2>outerr_sbom.log || rc_sbom=$?
          if [[ ${rc_sbom:-0} -ne 0 && -f "./outerr_sbom.log" ]]; then
            echo "ERROR: Failed to generate SBOM report:" >&2
            cat ./outerr_sbom.log >&2
          else
            echo "INFO: Scan completed. Result SBOM output path $(pwd)/trivy-image-cicd-runner-sbom.json"
          fi
          
          # Generate JSON report
          trivy image ${TRIVY_OUTPUT_OPTS} --format json --output trivy-image-cicd-runner.json "${IMAGE_REF}" >/dev/null 2>outerr_json.log || rc_json=$?
          if [[ ${rc_json:-0} -ne 0 && -f "./outerr_json.log" ]]; then
            echo "ERROR: Failed to generate JSON report:" >&2
            cat ./outerr_json.log >&2
          fi
      
      - name: Upload Trivy reports
        if: (steps.filter.outputs.cicd-runner == 'true' || (github.event_name == 'push' && github.ref_type == 'tag')) && always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-reports-cicd-runner-${{ steps.version.outputs.version }}
          path: |
            trivy-image-cicd-runner.txt
            trivy-image-cicd-runner.json
            trivy-image-cicd-runner.html
            trivy-image-cicd-runner.xml
            trivy-image-cicd-runner-sbom.json
          retention-days: 30
