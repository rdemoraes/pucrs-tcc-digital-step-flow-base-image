name: CI Pipeline - Workload Node 24

on:
  push:
    branches: [ main, develop ]
    paths: [ 'workload/node-24/**' ]
  pull_request:
    branches: [ main, develop ]
    paths: [ 'workload/node-24/**' ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

env:
  REGISTRY_URL: dhi.io
  BASE_IMAGE: raphaelmoraes/digital-step-flow-base-node
  NODEJS_VERSION: 24.13.0-r1
  NPM_VERSION: 11.6.3-r0
  ALPINE_BASE_VERSION: 3.23-alpine3.23-dev

jobs:
  build:
    name: Build Workload Node 24 Image
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      digest: ${{ steps.digest.outputs.digest }}
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Determine version based on branch strategy
        id: version
        env:
          GITHUB_REF_TYPE: ${{ github.ref_type }}
          GITHUB_REF: ${{ github.ref }}
          GITHUB_HEAD_REF: ${{ github.event.head_ref }}
          GITHUB_EVENT_PULL_REQUEST_HEAD_REF: ${{ github.event.pull_request.head.ref }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          source scripts/version.sh
          determine_version \
            "$GITHUB_REF_TYPE" \
            "$GITHUB_REF" \
            "$GITHUB_HEAD_REF" \
            "$GITHUB_EVENT_PULL_REQUEST_HEAD_REF" \
            "$GITHUB_REF_NAME"
          echo "Determined version: ${{ steps.version.outputs.version }}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to dhi.io registry
        run: |
          echo "${{ secrets.DOCKERHUB_PAT }}" | docker login dhi.io -u "${{ secrets.DOCKERHUB_USER }}" --password-stdin

      - name: Log in to Docker Hub
        run: |
          echo "${{ secrets.DOCKERHUB_PAT }}" | docker login -u "${{ secrets.DOCKERHUB_USER }}" --password-stdin

      - name: Validate version
        run: |
          if [[ -z "${{ steps.version.outputs.version }}" ]]; then
            echo "ERROR: Version is empty!" >&2
            exit 1
          fi
          echo "Building with version: ${{ steps.version.outputs.version }}"

      - name: Build and push workload node24 image
        uses: docker/bake-action@v5
        with:
          files: workload/node-24/docker-bake.hcl
          targets: base_image,base_image_dev
          push: true
          set: |
            *.args.REGISTRY_URL=${{ env.REGISTRY_URL }}
            *.args.ALPINE_BASE_VERSION=${{ env.ALPINE_BASE_VERSION }}
            *.args.NODEJS_VERSION=${{ env.NODEJS_VERSION }}
            *.args.NPM_VERSION=${{ env.NPM_VERSION }}
            *.args.BASE_IMAGE_VERSION=${{ steps.version.outputs.version }}

      - name: Get image digest
        id: digest
        run: |
          echo "${{ secrets.DOCKERHUB_PAT }}" | docker login -u "${{ secrets.DOCKERHUB_USER }}" --password-stdin
          DIGEST=$(docker buildx imagetools inspect "${{ env.BASE_IMAGE }}:${{ steps.version.outputs.version }}" 2>&1 | grep -E '^Digest:' | sed 's/Digest: *//')
          echo "digest=${DIGEST}" >> $GITHUB_OUTPUT
          echo "Image digest: ${DIGEST}"

      - name: Output image version
        run: |
          echo "IMAGE_VERSION=${{ steps.version.outputs.version }}" >> $GITHUB_ENV
          echo "Built image: ${{ env.BASE_IMAGE }}:${{ steps.version.outputs.version }}@${{ steps.digest.outputs.digest }}"

  trivy-scan:
    name: Trivy Vulnerability Scan
    needs: [build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Log in to Docker Hub
        run: |
          echo "${{ secrets.DOCKERHUB_PAT }}" | docker login -u "${{ secrets.DOCKERHUB_USER }}" --password-stdin

      - name: Pull image for scanning (by digest to ensure we scan the image that was just built)
        run: |
          docker pull ${{ env.BASE_IMAGE }}@${{ needs.build.outputs.digest }}

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: '${{ env.BASE_IMAGE }}@${{ needs.build.outputs.digest }}'
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'
          scanners: 'vuln'
          skip-dirs: './.venv'

      - name: Save Trivy table output to file
        run: |
          trivy image \
            --skip-version-check \
            --scanners vuln \
            --skip-dirs "./.venv" \
            --ignore-unfixed \
            --format table \
            --severity CRITICAL,HIGH \
            --output trivy-image-base.txt \
            '${{ env.BASE_IMAGE }}@${{ needs.build.outputs.digest }}' || true

      - name: Generate Trivy reports (HTML, XML, SBOM, JSON)
        env:
          IMAGE_REF: ${{ env.BASE_IMAGE }}@${{ needs.build.outputs.digest }}
        run: |
          if [[ -z "${IMAGE_REF}" ]]; then
            echo "ERROR: IMAGE_REF is empty!" >&2
            exit 1
          fi
          echo "INFO: Scanning image: ${IMAGE_REF}"
          mkdir -p /tmp/trivy-templates
          curl -sSL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/html.tpl -o /tmp/trivy-templates/trivy-html.tpl
          curl -sSL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/junit.tpl -o /tmp/trivy-templates/trivy-junit.tpl || true
          TRIVY_OUTPUT_OPTS="--skip-version-check --scanners vuln --skip-dirs ./.venv --ignore-unfixed"
          trivy image ${TRIVY_OUTPUT_OPTS} -o trivy-image-base.html --format template --template /tmp/trivy-templates/trivy-html.tpl "${IMAGE_REF}" >/dev/null 2>outerr_html.log || true
          [[ -f /tmp/trivy-templates/trivy-junit.tpl ]] && trivy image ${TRIVY_OUTPUT_OPTS} -o trivy-image-base.xml --format template --template /tmp/trivy-templates/trivy-junit.tpl "${IMAGE_REF}" >/dev/null 2>outerr_xml.log || true
          trivy image ${TRIVY_OUTPUT_OPTS} -o trivy-image-base-sbom.json --format cyclonedx "${IMAGE_REF}" >/dev/null 2>outerr_sbom.log || true
          trivy image ${TRIVY_OUTPUT_OPTS} --format json --output trivy-image-base.json "${IMAGE_REF}" >/dev/null 2>outerr_json.log || true

      - name: Upload Trivy reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-reports-base-image-${{ needs.build.outputs.version }}
          path: |
            trivy-image-base.txt
            trivy-image-base.json
            trivy-image-base.html
            trivy-image-base.xml
            trivy-image-base-sbom.json
          retention-days: 30
